#! /usr/bin/env python
#author: la_gent
#Ordinal inscription parser script

import sys, os, base64, argparse

witness_data = "2017f33ce8521f9a0c325dffa5c3ac7e191ab2b5d26b35eda313ed5293d5820b88ac0063036f726401010a696d6167652f77656270004d080252494646ca14000057454250565038580a00000020000000bd0000bd000049434350c8010000000001c800000000043000006d6e74725247422058595a2000000000000000000000000061637370000000000000000000000000000000000000000000000000000000010000f6d6000100000000d32d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000964657363000000f0000000247258595a00000114000000146758595a00000128000000146258595a0000013c00000014777470740000015000000014725452430000016400000028675452430000016400000028625452430000016400000028637072740000018c0000003c6d6c756300000000000000010000000c656e5553000000080000001c007300520047004258595a200000000000006fa2000038f50000039058595a2000000000000062990000b785000018da58595a2000000000000024a000000f840000b6cf58595a20000000000000f6d6000100000000d32d706172610000000000040000000266660000f2a700000d59000013d000000a5b00000000000000006d6c756300000000000000010000000c656e5553000000200000001c0047006f006f0067006c006500200049006e0063002e0020003200300031003656503820dc120000f047009d012abe00be003e9d409b4a25a3a24d080221acb86990b01389676edd5eba4d1e1d9919ee9f45f127e057ec3c27f2cfee2f74790444bfe69f837f5bec2bfa3ef27e5dff75ea0becadd45b61e805ee47da3fe9ff80f548faaf33becc7b007f37f387fe4f8497dd7fe77b017f34feb7ff7bfc77b1fffebfe63cee7d41ec0dfce3fb5fa657afffdb3fff1ee63fb1dffb8eaa62de3aa4146be8c8b3119153065506316014547fd5bef3c5093c63d620eb98fbaf89987a504933fa60f069fd045038b124a11c8649047e21ffe94b3b5015c231cd45a778ebfd3bd6bb6760834908fa053ca6e36cb1d63a72190e44885e193e1f99174f2716eaaf6afcc3e8c9dfe7b42318f720716296a8b3dc4d8b0d97796fd977a967ff354939a0b34c5f0d996cde5f7ae0ee69afa31ce91ef3bd60f4eb554ed6622b9086457620addcc272d1810bd8518aaa8b74f33527be744a1c187ebdbbe9d276499316218d1b26073e51a5d695e7188599875638203e4205afc34e09008df7d5e5fc58bdd9a384691a613fdde6fd6e9ca0e6fe79d96bfeaeec3cfa573317562953296198053ae5ed512a2733da5ee52a42aa6255ec486fb18432e191309bc654e769153fda45c79e1cf76684e2fc91b4772d6587c913f9b13e1896c1c234d720cbd77334af834b7f6576838e7b6f8aebc7ef1979498e0793e890765f7f9693a96c5506fba40a03349165c4d86e53e4f49e9a7a66e42fe6bd9f97441bcfcef1ff4c85bca9de3c4d08021fb074febdbcfe09ae3de61f2342779e24c3c8f5964bf5957d61268acd7ecec21338837170a5663de90362821e0000fef9dd4701835f000002faa0c2fa6a99123e3292b0c9e121757493dcc11c8cd94f182239a242fb76a5fdfa4e2c1e78f23652b242535dedda67e3ff98c5cde91e525e39c0a96017c395eebde4fcfdb6fad818027d81bd171fd40aa49ef4cac86b64015cf4859b50b33b15db8ff32cc46aec7ea0948c157910e7f744c47ed86ba8b93e94303e1e99472f63b8ed7e248f8c32891cdf14d04cb28784bf51878aaf91123ca3b025d2b429ef6b65d45fdeaf6715f2e5fc5d775170a406b62ed84506d51c24539257ef8585cc2f1414cde9bbd9905329d63a4da3b524dba29f373f6d2a0c9f17dbd23bceb0f3093782825f2cd812cd24ed9692000aabe11bb0cddb397e3032535fbf05889d9f6958681863825a3193fa1ef57d4007e3c8eac46a209d149c9808711e70d5b12b02db951cc0c1bdd4e854927e66efc6457fac8393ed63b02faabce28e18593a29a73f5d56a5bab4ecb926c1f3169a9348afe6ab42a186ed2f6d47e057fb089d20742372232a1776c698c3a9ff41ce74b566554789932d422b473c50edd33ec1bb289ca238a88f532efea085b5075556585ef06b529e331ea51a5a188c764bf6473e492a660ccf7df45264c1fc6e4170678fc7a983f7be29258851e92e481ca8b4deda598bab1dce4257cef8eb5a34426e4d08026e57a7d95fde1741c30b761d5625bfa97db6d2bd72f30c670830ae090442fbe5575d5effdd489b5afd052052bcb176287b1f16caf258791b955c92b30ea90fb8f90f87e5f621a831c123a6700cc4156c9d1848da568b4060574a36570a7119b6369f2447aa1c032fb78cb2c33902c190872cb9c9034c57c74b3916cd160e7a6a6b6c63609a088a84113d90d18f57aaa4f0e6d96467b90eead49569d13f6369d86158e96eb21cf4869135b117ea4f3e0ca1e6cbc385beda9c9dae5b2068a4c683b7e0ae9f3d18c6edaf57f9a036e2aeeaf62daaf00989cd3889d5100daab6ab8017551d94f3d4002994221828ae8879f7be87f77e89bf136445f81d319b2a91d124f37d7babb3ef27db87d8339fee1f476446187690c6b9f048f57527a95116f4750c2550d9b6d809b3cbd5e3faa8dd88f908a71d4103ef1e18450aeb126e62a4e5d9664f20a1298b072464eb43d1ebbffa51e724e9f1259f09e192f4f574492bd1b69273e708cfbadd97049e2dc2c28ede6b07ae07321b663296bd76fa7647558ddd62dc1cbfd6817c433a7dedcdd708f6c70c101ac6e7af6df3e20f673d62d722f5df0af7c08169e7f9a7bc083a607053f9320a49211f5ebf48483653e80f40ffdb8ffea72c7a1c55df099975b543294b62c5071674c921b92141f3cb305be5f370c0cf647e768af17302dfbc276d24ef51f7e93af1ef78ebd42df9a0dcd3c3345229221318d8894d0802159fd80313520c33dd3ac2b7f180ed77d30bd5c5014f034dd71784b0208a9ef962f98b081aa9a347d2cf5d63085d277bf9bf4c12a4e36a4caa1df1cedf39ae14b3bf5f453b806ae769a79a711938127ae37f317f68088245071346abeecda5612b181a4accd56c43a283bc41c635e00029817590cd17454e71c4de8dbd235ddb501f8e1cc23439fe384a6a37b94fb9b1da2fc6bcf4fc79188871fd73f7188cd042247ebd4ce2008fa75f8f0d791f826fb74b6d11587a24a201ac4269a705b79bb9cfbae1f588b0582b11af66b88032ebca82c8fe463112a47a82c24ce03304a17098041e2b3522df6b1e2255930c9c239b89e94da9bffdbeb135a032989a06e71ce1f4f1780c8e40f003e760994e54dac43cf4a4613ffe9016208d8e9664b18507ade6fe07b062f9338253921dea5f0325c3d40938e12846b0fd0e9c1e0fe427eb39f672b2bd88d9b8a04f0baf9da86c2725ade2be4935d46319358cd16bbaedfa783c5ac973f085dab25c284b604651d38b016fab64ebf7a09beffe5d73a828f52fb07b27f6ea705394bdf20a66844c07b3063dbeda7c4c488a3c8d9c36807170afb04e49c270922d55e55f8f3e42c1f40ee613ae2eb14abeeb4dc23e1db53a70483d122a8a1398510402970ace46a387a8075728d0141731e4827fd82feeb24dcd252e904531381e33cbcaa0a4aeede8411371786513c662afd97f2b996b192ab49d9e60ac19264d080204e6a613a1e6eeaa31fbf16c0072fe9e99a3d6d4ca98270ecd98f880b949c86245e4fadf1558fe9cdc7a6ccaf91741fb244eb26fcdb67a2eb90923f052497911122a97dde5a68e6219dca4a093258f978c442750279333b3bd5df73be8c76b8beb622ac4b95fdc5cea3ca0399684b596fd23af53d484811b2178d40ee041a65aba092ae3a5bfb31cb5fbdcbf6b46299b601a03d496f686bbb94dccb1cf8b532524f1b37a138f971708164bf70d6103e914f160e6fb7e262403bd72c239315b16f13936d174a04047d84060708749fd61282b9a23eef502c3a08a9537c7cce29b5f0f4000a82c71664333fc1e085dde88c1b9548ea1bdaa85fd1ccabc0fe250f78611c2aeaf3c68f0268e9189bec12fda3e3292bd0801be72edd197aeedc5fee03c85b3dd9259fd0c8c0666c4b443441fc2c41579cde5dc7e13098d0048c96e5030ec73924c2046b1e23c758f77117af4fcceaa96eadffde77e05e238c65113633576a44f1f402236c57c80a939d8bc55cfe2eb52e00f10067f36f5cbdd2972ff0b4d9828b8dff9ec0b24c8f635876a00902e43de4d198f541f34708c930f8028da916c4e34699ca72199c6a5ec8644e29a1f5923ec8dc71b4f334fa9c100e4eae1a055d55c60d6ef5d3fabe5f68d7a1a7a9e95a071ced7b64d46f86e88ecd3393f4647387593c4c91deba262738406a040233458026e49133ef7582d7f764f18de7f730f4c261f5d4d08029ade5495fdf7de64dfe0ae5642917f2e67f430d357faa600af276998c9c4e91fa481c2d4aeb0853340f3128c0abfea9b05b1e752d142240a6b1f9e035f0558be764e46d6763f882c3fe26ee548707ed2c493ac8925004307a16cf0706a47d44cab75ffc9d58459ca0cefde5f1e6cc0306d0dc2d05d9bce685c6e702f4d3d29cf091b3b688a425382ed8361c787cf8d452e6fb5f2285c4168fc3562210ffdd1e49faaf9544df02bbfba2020104d5f9d683af3ed54a019ac60ce77852b4056b1d50f0c9c600739e67ffdc994f3d4ba4938434f08f9b0b2e10533bb1ea2584198f1251f29e9c1d2e86a0434c012f7f17e9a98ea656bbef6a508f7cd15cdab0bcfd5807f46f2ea24d28554bcd861e221db8c1873f2908a60d85d915441fc1f8076553dc891571ae323e9c9e87f294b6ead17758aef945ab4ace59e9c858948909edb75fb21b236303b3fe715ea94c4e183307d1f359010de94f18b12a0f8415d3cf1104c4efe5ba9435d0a67375ff2f15f3160f4e429180df432357c68d6f04c2a8908736e1d87402c5d58cd7150711927f0bee2b163b8d739734b061415bab74549b03033ad7d96f50e6a8c6cea7b3d916b2c8b75139bf1df9ffe75126bc2af8c1f78fef89675fdaf999476c43e52b7c49c878a4c4f3017c40e6c72065f4d36257fb2877bda38481b554119fb463199b862a034fde0a4ba5bc9172c0b3dd3896885cc805bad4ca6f4e94d08027fd65b550443861f14322d3b6b93b265af601e817009304bf2107a91ec7b0212179d2c8980e26c5932f13c5661cb3b69d2b93b30d50a465758df99c449fc80c725296804b5ad1641e0c78d5701b7a8bf772ae30408fb2e4085aad796bedefca056d82f6d526cf499ee8a5ea90d159f523df0f658f6c96cb772f3461cf3251850506b55e1f8d5b2c07c2dcc7361319352b1c93fbc7a384a11b8e5314ac939516f52047700b0d8a9bb59195f8eea783daf2dc22db5328fcb357971e24ad2d37c6a5fb312552192be0386e572cc56c955e26409f1dd6fa372927ac3817c35934592e81d79d1ddb72962dd808e6a4d313572af35d4101cfbe81e0c7bb3c2f1d71105a7497112069209f153cd061a724b5322b2177fcb8bec7525a6e30f0eae26ccbf03e610d3c14ed7fdbaab95659a1808ab2fc80409e63b88d1a6355f7247029fdd0049f6675977765a35680097a205dbe97c10241b9bba12a8033eb25f8cd6699fe84bb751e2bcab028c5dc55df191731b35b8426c0c8eb8074879d38f92cbbe138de1073966409f607ef911bf804d300ee86d8f756d960940eb612602df946689fd7534fbb7170add61063eae24a882058b7219accbf1abe991e6bb5376b8024a10dce8b1e50eb0c089bee843fdfbd5a5055018688a4199c388a8055509238e98f75ee4d3a25ab5d7f1f84ea09e2f16fd8107c094d6f011f97270771201b2a54dfd87f07d0e5bedc94d0802e62cd587fa47f8e5a3771c6f6bed8fbfb8297187a2bbf6c096cfa6a76270fd5c69292e7edcb57c98c69185e9dd18e5ce81ff62b4f04be1bb631554f0dc7f966c33982221e313381f0e499f49451f39b032ba4a446f50affa0638e527a493178e4221bafd1332b8a319e144e758d5e931910f3bdfaf19d6c468d2832a35642cdde2586e7f12eb349b5ea6faa5cf7539b74f82e8d9335405cb267d95ee34af11900c59cc7284da9c988548d4cb18def735762fec2145d9baba5f24bb01ea009cdcfa67d01d8f59988b7f43d91274363a3ebd5ddc9751fc08031670bd36c569554e5c5bc2baec76d909f9a38739b1341396ea0812e6b4160d0908ccaf72cac6a386caade1ba02f9ccaca1300433702bd0a57e4d2ef11d687f1f50256b09184ee468613c03a11aa69ca264481776a741d88ea41d514123dd960a6d5d7fad0ab7908ca3e655743054b6e7c26fb0527b55b0dc54ce13d4296aa41f37d73a0df3bfb42b1c0aff3f97e635d07e9eb332c51ea9a7d9994227f7698a86a20fcf8c8204b063eae96fef87ca18cf1180312555d2260fc4d4e7c82146d3926cb2aa6431aacad707445e9a873f7b7016920d63ef539d049a102d57b62e5a970781786d5ea1eaa2df4cfe75cbfab67b7d4d69fcea5945dfb7e6b6e4f9321e8da3516c2067f5b2b0fc7127b25b1aad4c6674c1e63ce38f8a9a613908a720c4e81113831696efdef43db687046e25f1134d0802129e1b4357e6aca8948907fdc33120971fb1c48c32b41205fcf09aa0102b24fc54d02dcf8f5e7977c21f9755d76d8ed0262a9ec4df0e8cbd1d199a3ae922a936021d6a44edc4d3299a8fa1fb47e83f0ed553e845eca19298ad583d3b649f1421daa0ecab273a4e6a1cdde745a5bff2d0ccbf216cedf160cebc897f41dc2532ed0123dada7f0568c761f1ed4bc8788eeda7dd3454761d21a449912b8b577892d15295a6f1c0bfadf0a99805ba1e0fe7116ccb2a6ef2289de80edd24ec86f48ee2ca786fd11f07bf12fe8cff66ddae4c56174e465e34246bd4c02facb927a1b9bb4ad5c1379dcf6adfc113b196e7b48b19fd7647d5f2e60ae996f5f543c110396a793cf2f8681caa6aa9924e17189de90bb0ca7b6252086ba193e6175bf1056af7200da9800099c66be8c0d4e22630a1402fb5dc8a3a87bf47d5af41680226f076edfe50b23a438a4efc4d74a4a9be7dfb56301cfca1e51028b544f1ebf0088dbb312726abf6567b36934b96bcbc71ca805c7dd65e0898f419f710e5ae957f53a1a4b183ff6c097db30fdf607d6b8b349747d9d341b06469d565700251197d54d0c81ce8550d9185a019b0d1da252287345a3922eb8f91a61707043dfe93a16095e484a8d01f69746cecac4d7826000572510e6ba95fc3cc46e00c74fc4019ffef660b4866fc5c8b853b19d0b3bf16166c542e05fefb869739d9695106ccc31fbd93eb0cf7398240664c82b5e186e87cdf8cb243357bf33a26b7d0ec77ed4df4d4a20199c1b92798605dc862ef10366cf28c6c8ae20ee58d66359c052363fc1d7f3d5a04c6ea2b16676c182be19642f6685a3dde518a3c3723272e7d89734c213e2f66931d3b5affc627a7b4e6a31f7ec562a8b5ea042f22f306f18be32fe35770939e0b7bad1b6715e900000068"  # Add your witness data here as a string.

def get_cli_args():
	ap = argparse.ArgumentParser(description="Parse and output the ordinal inscription inside transaction")

	if witness_data is None:
		ap.add_argument("tx_file", help="input raw transaction file")

	ap.add_argument("-du", "--data-uri", action="store_true", help="print inscription as data-uri instead of writing to a file")
	ap.add_argument("-o", "--output", help="write inscription to OUTPUT file")

	return ap.parse_args()

def read_raw_data():
	global witness_data

	if witness_data is not None:
		raw = bytes.fromhex(witness_data)
	else:
		file = open(args.tx_file)
		raw = bytes.fromhex(file.read())
		file.close()
  
	return raw

def read_bytes(n = 1):
	global pointer

	value = raw[pointer : pointer + n]
	pointer += n
	return value

def get_initial_position():
	inscription_mark = bytes.fromhex("0063036f7264")
	try:
		return raw.index(inscription_mark) + len(inscription_mark)
	except ValueError:
		print(f"No ordinal inscription found in transaction", file = sys.stderr)
		sys.exit(1)

def read_content_type():
	OP_1 = b"\x51"
  
	byte = read_bytes()
	if byte != OP_1:
		assert(byte == b'\x01')
		assert(read_bytes() == b'\x01')

	size = int.from_bytes(read_bytes(), "big")
	content_type = read_bytes(size)
	return content_type.decode("utf8")

def read_pushdata(opcode):
	int_opcode = int.from_bytes(opcode, "big")

	if 0x01 <= int_opcode <= 0x4b:
		return read_bytes(int_opcode)
	
	num_bytes = 0
	if int_opcode == 0x4c:
		num_bytes = 1
	elif int_opcode == 0x4d:
		num_bytes = 2
	elif int_opcode == 0x4e:
		num_bytes = 4
	else:
		print(f"Invalid push opcode {hex(int_opcode)} at position {pointer}", file = sys.stderr)
		sys.exit(1)
	
	size = int.from_bytes(read_bytes(num_bytes), "little")
	return read_bytes(size)

def write_data_uri(data, content_type):
	data_base64 = base64.encodebytes(data).decode("ascii").replace("\n", "")
	print(f"data:{content_type};base64,{data_base64}")

def write_file(data):
	filename = args.output
	if filename is None:
		filename = base_filename = "inscription-output"
	else:
		base_filename = filename
		
	i = 1	
	while os.path.isfile(filename):
		i += 1
		filename = f"{base_filename}{i}"

	print(f"Writing contents to file \"{filename}\"")
	f = open(filename, "wb")
	f.write(data)
	f.close()

def main():
	global args, raw, pointer
	
	args = get_cli_args()
	raw = read_raw_data()
	pointer = get_initial_position()

	content_type = read_content_type()
	print(f"Content type: {content_type}")
	assert(read_bytes() == b'\x00')

	data = bytearray()

	OP_ENDIF = b"\x68"
	opcode = read_bytes()
	while opcode != OP_ENDIF:
		chunk = read_pushdata(opcode)
		data.extend(chunk)
		opcode = read_bytes()

	print(f"Total size: {len(data)} bytes")
	if args.data_uri:
		write_data_uri(data, content_type)
	else:
		write_file(data)
	
	print("\nDone")

main()
